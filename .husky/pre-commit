#!/bin/sh
set -e

# ---------------------------
# Helpers
# ---------------------------

fail() {
  echo "ğŸ›‘ $1"
  exit 1
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Content-only change detection (ignores chmod, CRLF noise)
has_content_changes() {
  ! git diff --quiet
}

print_changes() {
  git --no-pager diff --stat
}

# ---------------------------
# Environment checks
# ---------------------------

if ! command_exists pnpm; then
  fail "pnpm not found in PATH. Aborting commit."
fi

echo "ğŸš‘ Running pre-commit checks..."

# ---------------------------
# Type check (no fixes, must be clean)
# ---------------------------

echo ""
echo "ğŸ©º Running type check..."
pnpm run type-check || fail "Type check failed."
echo "âœ… Type check passed."

# ---------------------------
# Lint (with autofix)
# ---------------------------

echo ""
echo "ğŸš¨ Running lint (with fixes)..."
pnpm run lint:fix || fail "Lint failed."

if has_content_changes; then
  echo ""
  echo "âœï¸ Lint applied fixes to the following files:"
  print_changes
  echo ""
  fail "Please review and stage the changes, then re-run the commit."
fi

echo "âœ… Lint passed."

# ---------------------------
# Format (with autofix)
# ---------------------------

echo ""
echo "ğŸ¨ Running formatter..."
pnpm run format

if has_content_changes; then
  echo ""
  echo "âœï¸ Formatter applied changes to the following files:"
  print_changes
  echo ""
  fail "Please review and stage the changes, then re-run the commit."
fi

echo "âœ… Format passed."

# ---------------------------
# Done
# ---------------------------

echo ""
echo "ğŸš‘ Pre-commit checks passed. Proceeding with commit."
exit 0
